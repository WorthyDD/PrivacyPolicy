<!DOCTYPE html>
<!-- saved from url=(0079)https://sekaiapp-prod-data.s3.us-east-1.amazonaws.com/v3-games/dist/pgc/21.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Lumen - Spiritual Comfort</title>
  <script src="./Lumen - Spiritual Comfort_files/saved_resource"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com/">
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
  <link href="./Lumen - Spiritual Comfort_files/css2" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            serif: ['"Cormorant Garamond"', 'serif'],
            sans: ['"Lato"', 'sans-serif'],
          },
          colors: {
            paper: '#fdfbf7',
            stone: {
              50: '#fafaf9',
              100: '#f5f5f4',
              200: '#e7e5e4',
              300: '#d6d3d1',
              400: '#a8a29e',
              500: '#78716c',
              600: '#57534e',
              700: '#44403c',
              800: '#292524',
              900: '#1c1917',
            },
            rose: {
              50: '#fff1f2',
              400: '#fb7185',
              500: '#f43f5e',
            },
            gold: {
              100: '#fef9c3',
              200: '#fde047',
              300: '#fcd34d',
              400: '#fbbf24',
              500: '#f59e0b',
            }
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-out forwards',
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'slide-up': 'slideUp 0.3s ease-out forwards',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            },
            slideUp: {
              '0%': { transform: 'translateY(20px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' },
            }
          }
        },
      },
    }
  </script>

  <style>
    body {
      font-family: 'Lato', sans-serif;
      overscroll-behavior: none;
    }

    /* Hide scrollbar for Chrome, Safari and Opera */
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }

    /* Hide scrollbar for IE, Edge and Firefox */
    .no-scrollbar {
      -ms-overflow-style: none;  /* IE and Edge */
      scrollbar-width: none;  /* Firefox */
    }

    html {
      background-color: #fdfbf7; /* Match bg-paper to prevent black bars */
    }

    /* Keyboard open state handling */
    body.keyboard-open {
      overflow-y: auto !important; /* Allow scrolling when keyboard is open */
      min-height: 100vh;
    }

    body.keyboard-open nav {
      display: none !important;
    }

    body.keyboard-open .pb-24 {
      padding-bottom: 1rem !important; /* Reduce bottom padding to maximize space */
    }
  </style>
<style>*, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/* ! tailwindcss v3.4.17 | MIT License | https://tailwindcss.com */*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::after,::before{--tw-content:''}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:"Lato", sans-serif;font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.fixed{position:fixed}.absolute{position:absolute}.relative{position:relative}.bottom-0{bottom:0px}.bottom-4{bottom:1rem}.left-0{left:0px}.right-0{right:0px}.right-4{right:1rem}.z-50{z-index:50}.mx-auto{margin-left:auto;margin-right:auto}.mb-12{margin-bottom:3rem}.mb-2{margin-bottom:0.5rem}.mb-6{margin-bottom:1.5rem}.block{display:block}.flex{display:flex}.h-20{height:5rem}.h-40{height:10rem}.min-h-screen{min-height:100vh}.w-full{width:100%}.max-w-md{max-width:28rem}.flex-1{flex:1 1 0%}@keyframes slideUp{0%{transform:translateY(20px);opacity:0}100%{transform:translateY(0);opacity:1}}.animate-slide-up{animation:slideUp 0.3s ease-out forwards}.resize-none{resize:none}.flex-col{flex-direction:column}.items-start{align-items:flex-start}.items-center{align-items:center}.justify-center{justify-content:center}.justify-around{justify-content:space-around}.gap-1{gap:0.25rem}.overflow-hidden{overflow:hidden}.rounded-3xl{border-radius:1.5rem}.rounded-full{border-radius:9999px}.border{border-width:1px}.border-t{border-top-width:1px}.border-stone-100{--tw-border-opacity:1;border-color:rgb(245 245 244 / var(--tw-border-opacity, 1))}.border-stone-200{--tw-border-opacity:1;border-color:rgb(231 229 228 / var(--tw-border-opacity, 1))}.bg-paper{--tw-bg-opacity:1;background-color:rgb(253 251 247 / var(--tw-bg-opacity, 1))}.bg-paper\/90{background-color:rgb(253 251 247 / 0.9)}.bg-stone-100{--tw-bg-opacity:1;background-color:rgb(245 245 244 / var(--tw-bg-opacity, 1))}.bg-stone-800{--tw-bg-opacity:1;background-color:rgb(41 37 36 / var(--tw-bg-opacity, 1))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255 / var(--tw-bg-opacity, 1))}.p-2{padding:0.5rem}.p-3{padding:0.75rem}.p-6{padding:1.5rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.pb-24{padding-bottom:6rem}.pt-2{padding-top:0.5rem}.pt-24{padding-top:6rem}.text-center{text-align:center}.font-serif{font-family:"Cormorant Garamond", serif}.text-4xl{font-size:2.25rem;line-height:2.5rem}.text-\[10px\]{font-size:10px}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:0.875rem;line-height:1.25rem}.text-xs{font-size:0.75rem;line-height:1rem}.font-light{font-weight:300}.font-semibold{font-weight:600}.uppercase{text-transform:uppercase}.leading-relaxed{line-height:1.625}.tracking-widest{letter-spacing:0.1em}.text-stone-800{--tw-text-opacity:1;color:rgb(41 37 36 / var(--tw-text-opacity, 1))}.text-stone-400{--tw-text-opacity:1;color:rgb(168 162 158 / var(--tw-text-opacity, 1))}.text-stone-500{--tw-text-opacity:1;color:rgb(120 113 108 / var(--tw-text-opacity, 1))}.text-stone-700{--tw-text-opacity:1;color:rgb(68 64 60 / var(--tw-text-opacity, 1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}.opacity-50{opacity:0.5}.shadow-lg{--tw-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-sm{--tw-shadow:0 1px 2px 0 rgb(0 0 0 / 0.05);--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.backdrop-blur-md{--tw-backdrop-blur:blur(12px);-webkit-backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia);backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia)}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-colors{transition-property:color, background-color, border-color, fill, stroke, -webkit-text-decoration-color;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke, -webkit-text-decoration-color;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.duration-300{transition-duration:300ms}.placeholder\:text-stone-300::placeholder{--tw-text-opacity:1;color:rgb(214 211 209 / var(--tw-text-opacity, 1))}.hover\:scale-105:hover{--tw-scale-x:1.05;--tw-scale-y:1.05;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.focus\:border-stone-300:focus{--tw-border-opacity:1;border-color:rgb(214 211 209 / var(--tw-border-opacity, 1))}.focus\:outline-none:focus{outline:2px solid transparent;outline-offset:2px}.focus\:ring-1:focus{--tw-ring-offset-shadow:var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow:var(--tw-ring-inset) 0 0 0 calc(1px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000)}.focus\:ring-stone-300:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(214 211 209 / var(--tw-ring-opacity, 1))}.active\:scale-95:active{--tw-scale-x:.95;--tw-scale-y:.95;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}</style></head>
<body class="bg-paper text-stone-800 overflow-hidden">
  <div id="app">
        <div class="flex flex-col min-h-screen px-6 pt-24 pb-24 max-w-md mx-auto">
          <div class="mb-12 text-center animate-slide-up">
            <h1 class="font-serif text-4xl text-stone-800 mb-2">Lumen</h1>
            <p class="text-stone-500 text-xs tracking-widest uppercase font-semibold">Bible Verses for your Soul</p>
          </div>

          <div class="flex-1 flex flex-col justify-center animate-slide-up" style="animation-delay: 0.1s;">
            <label class="block text-lg font-serif text-stone-700 mb-2">
              How is your heart today?
            </label>
            <p class="text-sm text-stone-400 mb-6 font-light leading-relaxed">
              Share what you are going through, and we will find a comforting Bible verse specifically for you.
            </p>
            <div class="relative group">
              <textarea id="mood-input" placeholder="I&#39;m feeling anxious about the future..." class="w-full h-40 p-6 bg-white rounded-3xl border border-stone-100 shadow-sm focus:ring-1 focus:ring-stone-300 focus:border-stone-300 focus:outline-none resize-none text-lg font-serif text-stone-800 placeholder:text-stone-300 transition-all"></textarea>
              <div class="absolute bottom-4 right-4">
                <button data-action="search" class="p-3 bg-stone-800 text-white rounded-full shadow-lg hover:scale-105 active:scale-95 transition-all opacity-50" disabled="">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path></svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      
        <nav class="fixed bottom-0 left-0 right-0 bg-paper/90 backdrop-blur-md border-t border-stone-200 pb-safe pt-2 px-6 shadow-lg z-50 h-20 flex items-start justify-around">
          <button data-action="nav-search" class="flex flex-col items-center gap-1 transition-colors duration-300 text-stone-800">
            <div class="p-2 rounded-full bg-stone-100">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            </div>
            <span class="text-[10px] tracking-widest uppercase font-semibold">Seek</span>
          </button>

          <button data-action="nav-collections" class="flex flex-col items-center gap-1 transition-colors duration-300 text-stone-400">
            <div class="p-2 rounded-full ">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"></path><path d="M16 8.2C16 7 15 6 13.8 6c-.8 0-1.4.3-1.8.9-.4-.6-1-.9-1.8-.9C9 6 8 7 8 8.2c0 .6.3 1.2.7 1.6h0C10 11.1 12 13 12 13s2-1.9 3.3-3.1h0c.4-.4.7-1 .7-1.7z"></path></svg>
            </div>
            <span class="text-[10px] tracking-widest uppercase font-semibold">Keep</span>
          </button>
        </nav>
      </div>

  <script>
    // ==================== STATE MANAGEMENT ====================

    const state = {
      // View state
      currentView: 'SEARCH', // 'SEARCH' | 'RESULT' | 'COLLECTIONS'
      userInput: '',
      loadingState: 'idle', // 'idle' | 'searching' | 'finding-similar'

      // Verse data (in-memory only, no localStorage)
      currentVerse: null,
      similarVerses: [],
      savedVerses: [],

      // Collections
      collections: [],
      activeCollectionId: null,

      // Selection mode
      selectionMode: false,
      selectedVerseIds: [],
      isCollectionModalOpen: false,
      newCollectionName: '',

      // AI callbacks
      pendingAICallbacks: new Map()
    };

    // ==================== SEKAI IFRAME API ====================

    let taskIdCounter = 0;

    function callLLM(systemPrompt, userPrompt, responseSchema, callback) {
      const taskId = `llm-${Date.now()}-${taskIdCounter++}`;
      state.pendingAICallbacks.set(taskId, callback);

      window.parent.postMessage({
        origin: 'sekai_gaming_iframe_api',
        type: 'call_llm',
        taskId: taskId,
        data: {
          systemPrompt: systemPrompt,
          userPrompt: userPrompt,
          responseSchema: responseSchema
        }
      }, '*');
    }

    // Listen for AI responses
    window.addEventListener('message', (event) => {
      if (event.data.origin === 'sekai_gaming_iframe_api' &&
          event.data.type === 'receive_call_llm') {
        const { taskId, data, error } = event.data;
        const callback = state.pendingAICallbacks.get(taskId);

        if (callback) {
          if (error) {
            callback(null, error);
          } else {
            callback(data, null);
          }
          state.pendingAICallbacks.delete(taskId);
        }
      }
    });

    // ==================== HELPER FUNCTIONS ====================

    function generateId() {
      return Math.random().toString(36).substr(2, 9);
    }

    function findVerseById(id) {
      return state.savedVerses.find(v => v.id === id);
    }

    function isVerseSaved(verse) {
      return state.savedVerses.some(v => v.reference === verse.reference);
    }

    // ==================== AI SERVICE FUNCTIONS ====================

    function fetchVerseForMood(mood, callback) {
      const systemPrompt = "You are a spiritual companion. Be gentle, wise, and comforting. Do not be preachy. Focus on grace, hope, and strength.";
      const userPrompt = `The user is feeling: "${mood}". Find a comforting, uplifting, or guiding Bible verse specifically for this situation. Provide a gentle explanation. Use a modern, readable translation like NIV, ESV, or NLT.`;

      const responseSchema = {
        type: 'object',
        properties: {
          verse: {
            type: 'object',
            properties: {
              reference: { type: 'string', description: 'The Bible reference (e.g., John 3:16)' },
              text: { type: 'string', description: 'The actual scripture text' },
              explanation: { type: 'string', description: 'A brief, comforting explanation of why this fits the user\'s situation' },
              version: { type: 'string', description: 'The Bible version used (e.g., NIV, ESV)' }
            },
            required: ['reference', 'text', 'explanation', 'version']
          }
        },
        required: ['verse'],
        additionalProperties: false
      };

      callLLM(systemPrompt, userPrompt, responseSchema, (data, error) => {
        if (error) {
          callback(null, error);
        } else {
          callback(data.verse, null);
        }
      });
    }

    function fetchSimilarVerses(originalVerse, mood, callback) {
      const systemPrompt = "You are a spiritual companion helping users explore scripture.";
      const userPrompt = `The user resonated with this verse: "${originalVerse}" for their situation: "${mood}". Find 3 other DISTINCT Bible verses that share a similar theme or message.`;

      const responseSchema = {
        type: 'object',
        properties: {
          verses: {
            type: 'array',
            items: {
              type: 'object',
              properties: {
                reference: { type: 'string', description: 'The Bible reference' },
                text: { type: 'string', description: 'The scripture text' },
                explanation: { type: 'string', description: 'Why this verse relates to the original' },
                version: { type: 'string', description: 'The Bible version' }
              },
              required: ['reference', 'text', 'explanation', 'version']
            }
          }
        },
        required: ['verses'],
        additionalProperties: false
      };

      callLLM(systemPrompt, userPrompt, responseSchema, (data, error) => {
        if (error) {
          callback(null, error);
        } else {
          callback(data.verses, null);
        }
      });
    }

    // ==================== ICON SVG TEMPLATES ====================

    const icons = {
      home: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>`,

      bookHeart: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"></path><path d="M16 8.2C16 7 15 6 13.8 6c-.8 0-1.4.3-1.8.9-.4-.6-1-.9-1.8-.9C9 6 8 7 8 8.2c0 .6.3 1.2.7 1.6h0C10 11.1 12 13 12 13s2-1.9 3.3-3.1h0c.4-.4.7-1 .7-1.7z"></path></svg>`,

      heart: (isFilled) => `<svg width="20" height="20" viewBox="0 0 24 24" fill="${isFilled ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`,

      share2: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>`,

      plus: (size = 14) => `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`,

      sparkles: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path><path d="M5 3v4"></path><path d="M19 17v4"></path><path d="M3 5h4"></path><path d="M17 19h4"></path></svg>`,

      search: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path></svg>`,

      arrowLeft: (size = 16) => `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>`,

      folderPlus: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path><line x1="12" y1="11" x2="12" y2="17"></line><line x1="9" y1="14" x2="15" y2="14"></line></svg>`,

      x: (size = 18) => `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`,

      trash2: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`,

      check: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`
    };

    // ==================== RENDER FUNCTIONS ====================

    function renderLoader(message) {
      return `
        <div class="flex flex-col items-center justify-center h-64 animate-fade-in">
          <div class="relative w-16 h-16 mb-6">
            <div class="absolute inset-0 bg-stone-200 rounded-full opacity-20 animate-ping"></div>
            <div class="absolute inset-2 bg-gradient-to-tr from-stone-100 to-orange-50 rounded-full shadow-inner flex items-center justify-center animate-pulse-slow">
              <div class="text-stone-400">${icons.sparkles}</div>
            </div>
          </div>
          <p class="font-serif text-lg text-stone-600">${message}</p>
        </div>
      `;
    }

    function renderNavBar() {
      const isSearchActive = state.currentView === 'SEARCH';
      const isCollectionsActive = state.currentView === 'COLLECTIONS';

      return `
        <nav class="fixed bottom-0 left-0 right-0 bg-paper/90 backdrop-blur-md border-t border-stone-200 pb-safe pt-2 px-6 shadow-lg z-50 h-20 flex items-start justify-around">
          <button data-action="nav-search" class="flex flex-col items-center gap-1 transition-colors duration-300 ${isSearchActive ? 'text-stone-800' : 'text-stone-400'}">
            <div class="p-2 rounded-full ${isSearchActive ? 'bg-stone-100' : ''}">
              ${icons.home}
            </div>
            <span class="text-[10px] tracking-widest uppercase font-semibold">Seek</span>
          </button>

          <button data-action="nav-collections" class="flex flex-col items-center gap-1 transition-colors duration-300 ${isCollectionsActive ? 'text-stone-800' : 'text-stone-400'}">
            <div class="p-2 rounded-full ${isCollectionsActive ? 'bg-stone-100' : ''}">
              ${icons.bookHeart}
            </div>
            <span class="text-[10px] tracking-widest uppercase font-semibold">Keep</span>
          </button>
        </nav>
      `;
    }

    function renderVerseCard(verse, options = {}) {
      const {
        showActions = true,
        isSaved = false,
        showFindSimilar = false,
        selectionMode = false,
        selected = false
      } = options;

      return `
        <div
          class="relative bg-white p-6 rounded-3xl shadow-sm border transition-all duration-300 overflow-hidden group ${
            selected ? 'border-stone-800 bg-stone-50 ring-1 ring-stone-800' : 'border-stone-100'
          } ${selectionMode ? 'cursor-pointer active:scale-95' : ''}"
          data-action="${selectionMode ? 'toggle-select' : ''}"
          data-verse-id="${verse.id}"
        >
          ${selectionMode ? `
            <div class="absolute top-4 right-4 w-6 h-6 rounded-full border flex items-center justify-center transition-colors ${
              selected ? 'bg-stone-800 border-stone-800' : 'border-stone-300 bg-white'
            }">
              ${selected ? `<div class="text-white">${icons.check}</div>` : ''}
            </div>
          ` : ''}

          <div class="mb-4">
            <p class="font-serif text-2xl leading-relaxed text-stone-800 mb-3">
              "${verse.text}"
            </p>
            <div class="flex items-baseline justify-between">
              <p class="text-xs font-bold tracking-widest uppercase text-stone-500">
                ${verse.reference}
              </p>
              ${verse.version ? `
                <span class="text-[10px] text-stone-400 bg-stone-100 px-2 py-0.5 rounded-full">
                  ${verse.version}
                </span>
              ` : ''}
            </div>
          </div>

          ${verse.explanation ? `
            <div class="mt-4 pt-4 border-t border-stone-100">
              <p class="text-sm text-stone-600 italic leading-relaxed">
                ${verse.explanation}
              </p>
            </div>
          ` : ''}

          ${!selectionMode && showActions ? `
            <div class="flex items-center justify-between mt-6 pt-2">
              <div class="flex gap-3">
                <button
                  data-action="save-verse"
                  data-verse-id="${verse.id}"
                  class="p-2 rounded-full transition-colors ${
                    isSaved ? 'bg-rose-50 text-rose-500' : 'bg-stone-50 text-stone-400 hover:bg-stone-100'
                  }"
                >
                  ${icons.heart(isSaved)}
                </button>
                <button class="p-2 rounded-full bg-stone-50 text-stone-400 hover:bg-stone-100 transition-colors">
                  ${icons.share2}
                </button>
              </div>

              ${showFindSimilar ? `
                <button
                  data-action="find-similar"
                  data-verse-id="${verse.id}"
                  class="text-xs font-semibold uppercase tracking-wider text-stone-500 hover:text-stone-800 flex items-center gap-1 px-3 py-2 rounded-full hover:bg-stone-50 transition-colors"
                >
                  ${icons.plus(14)} Similar
                </button>
              ` : ''}
            </div>
          ` : ''}
        </div>
      `;
    }

    function renderSearchView() {
      return `
        <div class="flex flex-col min-h-screen px-6 pt-24 pb-24 max-w-md mx-auto">
          <div class="mb-12 text-center animate-slide-up">
            <h1 class="font-serif text-4xl text-stone-800 mb-2">Lumen</h1>
            <p class="text-stone-500 text-xs tracking-widest uppercase font-semibold">Bible Verses for your Soul</p>
          </div>

          <div class="flex-1 flex flex-col justify-center animate-slide-up" style="animation-delay: 0.1s;">
            <label class="block text-lg font-serif text-stone-700 mb-2">
              How is your heart today?
            </label>
            <p class="text-sm text-stone-400 mb-6 font-light leading-relaxed">
              Share what you are going through, and we will find a comforting Bible verse specifically for you.
            </p>
            <div class="relative group">
              <textarea
                id="mood-input"
                placeholder="I'm feeling anxious about the future..."
                class="w-full h-40 p-6 bg-white rounded-3xl border border-stone-100 shadow-sm focus:ring-1 focus:ring-stone-300 focus:border-stone-300 focus:outline-none resize-none text-lg font-serif text-stone-800 placeholder:text-stone-300 transition-all"
              >${state.userInput}</textarea>
              <div class="absolute bottom-4 right-4">
                <button
                  data-action="search"
                  class="p-3 bg-stone-800 text-white rounded-full shadow-lg hover:scale-105 active:scale-95 transition-all ${!state.userInput.trim() ? 'opacity-50' : ''}"
                  ${!state.userInput.trim() ? 'disabled' : ''}
                >
                  ${icons.search}
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderResultView() {
      return `
        <div class="min-h-screen pb-24 px-4 pt-6 max-w-md mx-auto">
          <button
            data-action="back-to-search"
            class="mb-6 flex items-center gap-2 text-stone-400 hover:text-stone-800 transition-colors text-sm font-medium"
          >
            ${icons.arrowLeft(16)} Back to Search
          </button>

          ${state.currentVerse ? `
            <div class="animate-slide-up">
              <div class="mb-2 px-2 flex justify-between items-center">
                <h2 class="font-serif text-2xl text-stone-800">For You</h2>
              </div>
              ${renderVerseCard(state.currentVerse, {
                showActions: true,
                isSaved: isVerseSaved(state.currentVerse),
                showFindSimilar: true
              })}
            </div>
          ` : ''}

          ${state.loadingState === 'finding-similar' ? renderLoader("Finding similar verses...") : ''}

          ${state.similarVerses.length > 0 ? `
            <div class="mt-8 animate-fade-in">
              <div class="flex items-center gap-2 mb-4 px-2">
                <div class="h-px flex-1 bg-stone-200"></div>
                <span class="text-xs font-bold tracking-widest uppercase text-stone-400">Related Verses</span>
                <div class="h-px flex-1 bg-stone-200"></div>
              </div>
              <div class="flex flex-col gap-4">
                ${state.similarVerses.map(verse => renderVerseCard(verse, {
                  showActions: true,
                  isSaved: isVerseSaved(verse),
                  showFindSimilar: false
                })).join('')}
              </div>
            </div>
          ` : ''}
        </div>
      `;
    }

    function renderCollectionsView() {
      const displayVerses = state.activeCollectionId
        ? state.savedVerses.filter(v => {
            const collection = state.collections.find(c => c.id === state.activeCollectionId);
            return collection && collection.verseIds.includes(v.id);
          })
        : state.savedVerses;

      const activeCollection = state.collections.find(c => c.id === state.activeCollectionId);

      return `
        <div class="min-h-screen pb-24 px-4 pt-12 max-w-md mx-auto">
          <div class="mb-8 px-2">
            ${state.activeCollectionId ? `
              <div class="animate-slide-up">
                <button
                  data-action="clear-active-collection"
                  class="mb-2 text-stone-400 text-sm flex items-center gap-1"
                >
                  ${icons.arrowLeft(14)} All Collections
                </button>
                <div class="flex items-center justify-between">
                  <h1 class="font-serif text-3xl text-stone-800">${activeCollection?.name || ''}</h1>
                  <button
                    data-action="delete-collection"
                    data-collection-id="${state.activeCollectionId}"
                    class="text-rose-400 p-2"
                  >
                    ${icons.trash2}
                  </button>
                </div>
              </div>
            ` : `
              <div class="flex items-end justify-between animate-slide-up">
                <div>
                  <h1 class="font-serif text-3xl text-stone-800 mb-1">Collections</h1>
                  <p class="text-stone-400 text-xs tracking-wider uppercase">Your Spiritual Library</p>
                </div>
                ${!state.selectionMode ? `
                  <button
                    data-action="start-selection"
                    class="text-stone-500 text-sm font-medium flex items-center gap-1 hover:text-stone-800 transition-colors"
                  >
                    ${icons.plus(16)} Create
                  </button>
                ` : ''}
              </div>
            `}
          </div>

          ${!state.activeCollectionId && !state.selectionMode && state.collections.length > 0 ? `
            <div class="mb-8 flex gap-3 overflow-x-auto pb-4 no-scrollbar px-2 animate-fade-in">
              ${state.collections.map(collection => `
                <button
                  data-action="view-collection"
                  data-collection-id="${collection.id}"
                  class="flex-shrink-0 w-32 h-32 bg-stone-100 rounded-2xl p-4 flex flex-col justify-between text-left hover:bg-stone-200 transition-colors border border-stone-200"
                >
                  <div class="text-stone-400">${icons.folderPlus}</div>
                  <div>
                    <p class="font-serif text-lg leading-tight text-stone-800 line-clamp-2">${collection.name}</p>
                    <p class="text-[10px] text-stone-500 mt-1">${collection.verseIds.length} verses</p>
                  </div>
                </button>
              `).join('')}
            </div>
          ` : ''}

          ${state.selectionMode ? `
            <div class="bg-stone-800 text-white p-4 rounded-2xl mb-6 flex items-center justify-between animate-slide-up shadow-lg mx-2 sticky top-4 z-30">
              <span class="text-sm font-medium">${state.selectedVerseIds.length} selected</span>
              <div class="flex gap-3">
                <button
                  data-action="cancel-selection"
                  class="p-2 hover:bg-stone-700 rounded-full"
                >
                  ${icons.x(18)}
                </button>
                <button
                  data-action="open-collection-modal"
                  class="bg-white text-stone-900 px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-wider ${state.selectedVerseIds.length === 0 ? 'opacity-50' : ''}"
                  ${state.selectedVerseIds.length === 0 ? 'disabled' : ''}
                >
                  Group
                </button>
              </div>
            </div>
          ` : ''}

          <div class="space-y-4 animate-slide-up" style="animation-delay: 0.1s;">
            ${displayVerses.length === 0 ? `
              <div class="text-center py-12 border-2 border-dashed border-stone-200 rounded-3xl">
                <p class="text-stone-400 font-serif italic">No verses saved yet.</p>
              </div>
            ` : displayVerses.map(verse => renderVerseCard(verse, {
              showActions: !state.selectionMode,
              isSaved: true,
              showFindSimilar: false,
              selectionMode: state.selectionMode,
              selected: state.selectedVerseIds.includes(verse.id)
            })).join('')}
          </div>
        </div>
      `;
    }

    function renderCollectionModal() {
      if (!state.isCollectionModalOpen) return '';

      return `
        <div class="fixed inset-0 z-[60] flex items-center justify-center px-6">
          <div class="absolute inset-0 bg-stone-900/40 backdrop-blur-sm" data-action="close-modal"></div>
          <div class="bg-white w-full max-w-sm p-6 rounded-3xl shadow-2xl relative z-10 animate-slide-up">
            <h3 class="font-serif text-2xl text-stone-800 mb-4">Name Collection</h3>
            <input
              type="text"
              id="collection-name-input"
              placeholder="e.g., Strength, Peace..."
              value="${state.newCollectionName}"
              class="w-full p-3 bg-stone-50 rounded-xl border border-stone-200 focus:outline-none focus:ring-1 focus:ring-stone-800 mb-6 text-stone-800 font-serif text-lg"
            />
            <div class="flex gap-3">
              <button
                data-action="close-modal"
                class="flex-1 py-3 rounded-xl text-stone-500 font-medium hover:bg-stone-50 transition-colors"
              >
                Cancel
              </button>
              <button
                data-action="create-collection"
                class="flex-1 py-3 bg-stone-800 text-white rounded-xl font-medium shadow-lg hover:bg-stone-900 transition-all ${!state.newCollectionName.trim() ? 'opacity-50' : ''}"
                ${!state.newCollectionName.trim() ? 'disabled' : ''}
              >
                Create
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // ==================== MAIN RENDER ====================

    function render() {
      const app = document.getElementById('app');
      let html = '';

      // Loading overlay
      if (state.loadingState === 'searching') {
        html += `
          <div class="fixed inset-0 bg-white/80 backdrop-blur-sm z-50 flex items-center justify-center">
            ${renderLoader("Finding a verse for you...")}
          </div>
        `;
      }

      // Main content
      if (state.currentView === 'SEARCH') {
        html += renderSearchView();
      } else if (state.currentView === 'RESULT') {
        html += renderResultView();
      } else if (state.currentView === 'COLLECTIONS') {
        html += renderCollectionsView();
      }

      // Navigation
      html += renderNavBar();

      // Modal
      html += renderCollectionModal();

      app.innerHTML = html;
      attachEventListeners();
    }

    // ==================== EVENT HANDLERS ====================

    function handleSearch() {
      if (!state.userInput.trim()) return;

      state.loadingState = 'searching';
      state.similarVerses = [];
      state.currentView = 'RESULT';
      render();

      fetchVerseForMood(state.userInput, (verseData, error) => {
        if (error) {
          console.error("Failed to fetch", error);
          state.currentView = 'SEARCH';
          state.loadingState = 'idle';
          render();
          alert("We couldn't find a verse right now. Please try again.");
        } else {
          const newVerse = {
            id: generateId(),
            ...verseData,
            tags: [state.userInput],
            timestamp: Date.now()
          };
          state.currentVerse = newVerse;
          state.loadingState = 'idle';
          render();
        }
      });
    }

    function handleFindSimilar(verseId) {
      const verse = state.currentVerse?.id === verseId
        ? state.currentVerse
        : state.similarVerses.find(v => v.id === verseId);

      if (!verse) return;

      state.loadingState = 'finding-similar';
      render();

      fetchSimilarVerses(verse.text, state.userInput || "spiritual encouragement", (verses, error) => {
        if (error) {
          console.error(error);
          state.loadingState = 'idle';
          render();
          alert("Could not find similar verses at this moment.");
        } else {
          const newVerses = verses.map(v => ({
            id: generateId(),
            ...v,
            tags: [state.userInput, 'similar'],
            timestamp: Date.now()
          }));
          state.similarVerses = newVerses;
          state.loadingState = 'idle';
          render();
        }
      });
    }

    function toggleSaveVerse(verseId) {
      let verse;
      if (state.currentVerse?.id === verseId) {
        verse = state.currentVerse;
      } else {
        verse = state.similarVerses.find(v => v.id === verseId) ||
                state.savedVerses.find(v => v.id === verseId);
      }

      if (!verse) return;

      if (state.savedVerses.some(v => v.reference === verse.reference)) {
        state.savedVerses = state.savedVerses.filter(v => v.reference !== verse.reference);
      } else {
        state.savedVerses = [verse, ...state.savedVerses];
      }

      render();
    }

    function toggleSelection(verseId) {
      const index = state.selectedVerseIds.indexOf(verseId);
      if (index > -1) {
        state.selectedVerseIds.splice(index, 1);
      } else {
        state.selectedVerseIds.push(verseId);
      }
      render();
    }

    function startSelectionMode() {
      state.selectionMode = true;
      state.selectedVerseIds = [];
      render();
    }

    function cancelSelectionMode() {
      state.selectionMode = false;
      state.selectedVerseIds = [];
      render();
    }

    function createCollection() {
      if (!state.newCollectionName.trim()) return;

      const newCollection = {
        id: generateId(),
        name: state.newCollectionName,
        verseIds: [...state.selectedVerseIds],
        createdAt: Date.now()
      };

      state.collections.push(newCollection);
      state.newCollectionName = '';
      state.isCollectionModalOpen = false;
      cancelSelectionMode();
    }

    function deleteCollection(collectionId) {
      if (confirm('Are you sure you want to delete this collection? Verses will remain in your library.')) {
        state.collections = state.collections.filter(c => c.id !== collectionId);
        if (state.activeCollectionId === collectionId) {
          state.activeCollectionId = null;
        }
        render();
      }
    }

    // ==================== EVENT LISTENER ATTACHMENT ====================

    function attachEventListeners() {
      const app = document.getElementById('app');

      // Navigation
      const searchNavBtn = app.querySelector('[data-action="nav-search"]');
      if (searchNavBtn) {
        searchNavBtn.addEventListener('click', () => {
          state.currentView = 'SEARCH';
          render();
        });
      }

      const collectionsNavBtn = app.querySelector('[data-action="nav-collections"]');
      if (collectionsNavBtn) {
        collectionsNavBtn.addEventListener('click', () => {
          state.currentView = 'COLLECTIONS';
          render();
        });
      }

      // Search view
      const moodInput = document.getElementById('mood-input');
      if (moodInput) {
        // Handle keyboard visibility
        moodInput.addEventListener('focus', () => {
          document.body.classList.add('keyboard-open');
        });
        moodInput.addEventListener('blur', () => {
          // Small delay to prevent flickering if switching focus
          setTimeout(() => {
            document.body.classList.remove('keyboard-open');
          }, 100);
        });

        moodInput.addEventListener('input', (e) => {
          state.userInput = e.target.value;
          // Update button disabled state dynamically
          const searchBtn = app.querySelector('[data-action="search"]');
          if (searchBtn) {
            if (state.userInput.trim()) {
              searchBtn.disabled = false;
              searchBtn.classList.remove('opacity-50');
            } else {
              searchBtn.disabled = true;
              searchBtn.classList.add('opacity-50');
            }
          }
        });

        moodInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && e.shiftKey) {
            // Allow shift+enter for new line
            return;
          } else if (e.key === 'Enter') {
            e.preventDefault();
            handleSearch();
          }
        });
      }

      const searchBtn = app.querySelector('[data-action="search"]');
      if (searchBtn) {
        searchBtn.addEventListener('click', handleSearch);
      }

      // Result view
      const backBtn = app.querySelector('[data-action="back-to-search"]');
      if (backBtn) {
        backBtn.addEventListener('click', () => {
          state.currentView = 'SEARCH';
          render();
        });
      }

      // Save verse buttons
      app.querySelectorAll('[data-action="save-verse"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const verseId = btn.dataset.verseId;
          toggleSaveVerse(verseId);
        });
      });

      // Find similar buttons
      app.querySelectorAll('[data-action="find-similar"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const verseId = btn.dataset.verseId;
          handleFindSimilar(verseId);
        });
      });

      // Collections view
      const startSelectionBtn = app.querySelector('[data-action="start-selection"]');
      if (startSelectionBtn) {
        startSelectionBtn.addEventListener('click', startSelectionMode);
      }

      const cancelSelectionBtn = app.querySelector('[data-action="cancel-selection"]');
      if (cancelSelectionBtn) {
        cancelSelectionBtn.addEventListener('click', cancelSelectionMode);
      }

      const openModalBtn = app.querySelector('[data-action="open-collection-modal"]');
      if (openModalBtn) {
        openModalBtn.addEventListener('click', () => {
          state.isCollectionModalOpen = true;
          render();
          // Auto-focus the input
          setTimeout(() => {
            const input = document.getElementById('collection-name-input');
            if (input) input.focus();
          }, 100);
        });
      }

      // Toggle selection in selection mode
      app.querySelectorAll('[data-action="toggle-select"]').forEach(card => {
        card.addEventListener('click', () => {
          const verseId = card.dataset.verseId;
          toggleSelection(verseId);
        });
      });

      // View collection
      app.querySelectorAll('[data-action="view-collection"]').forEach(btn => {
        btn.addEventListener('click', () => {
          const collectionId = btn.dataset.collectionId;
          state.activeCollectionId = collectionId;
          render();
        });
      });

      // Clear active collection
      const clearActiveBtn = app.querySelector('[data-action="clear-active-collection"]');
      if (clearActiveBtn) {
        clearActiveBtn.addEventListener('click', () => {
          state.activeCollectionId = null;
          render();
        });
      }

      // Delete collection
      app.querySelectorAll('[data-action="delete-collection"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const collectionId = btn.dataset.collectionId;
          deleteCollection(collectionId);
        });
      });

      // Modal
      const collectionNameInput = document.getElementById('collection-name-input');
      if (collectionNameInput) {
        collectionNameInput.addEventListener('input', (e) => {
          state.newCollectionName = e.target.value;
          // Update button disabled state dynamically
          const createBtn = app.querySelector('[data-action="create-collection"]');
          if (createBtn) {
            if (state.newCollectionName.trim()) {
              createBtn.disabled = false;
              createBtn.classList.remove('opacity-50');
            } else {
              createBtn.disabled = true;
              createBtn.classList.add('opacity-50');
            }
          }
        });

        collectionNameInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            createCollection();
          }
        });
      }

      app.querySelectorAll('[data-action="close-modal"]').forEach(btn => {
        btn.addEventListener('click', () => {
          state.isCollectionModalOpen = false;
          state.newCollectionName = '';
          render();
        });
      });

      const createCollectionBtn = app.querySelector('[data-action="create-collection"]');
      if (createCollectionBtn) {
        createCollectionBtn.addEventListener('click', createCollection);
      }
    }

    // ==================== INITIALIZATION ====================

    document.addEventListener('DOMContentLoaded', () => {
      render();
    });
  </script>


</body></html>
